<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Quantum Hex</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f4f7f9; padding: 20px; color: #333; }
    h1 { color: #222; }
    .coin-string, .popup, button, .winner { margin-top: 12px; }
    .coin-string {
      font-family: monospace; background: #fff; border: 1px dashed #ccc;
      padding: 8px; margin-bottom: 12px;
    }
    .winner { color: green; font-weight: bold; font-size: 20px; }
    button { padding: 8px 16px; font-size: 14px; cursor: pointer; }
    .board-container { display: flex; gap: 40px; margin-top: 20px; }
    .board-box { text-align: center; }
    svg { background: white; border: 1px solid #ccc; }
    .popup {
      position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%);
      background: #fff; border: 3px solid #222; padding: 24px 40px; font-size: 32px;
      font-weight: bold; border-radius: 12px; z-index: 1000; display: none;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
  <h2>Select Game Mode</h2>
  <button onclick="setMode('local')">Local Mode</button>
  <button onclick="setMode('online')">Online Mode</button>
  <div id="online-setup" style="display:none; margin-top:10px;">
    <input id="roomId" placeholder="Enter Room ID" />
    <button onclick="joinOnline()">Join Room</button>
  </div>

  <h1>Quantum Hex (11√ó11)</h1>
  <div><strong>Public Coin String:</strong></div>
  <div id="coinString" class="coin-string"></div>
  <div id="coinHint" style="font-family: monospace; white-space: pre-line;
              background: #eef; border-left: 4px solid #88f;
              padding: 8px; margin-top: 8px;"></div>
  <div id="status"></div>
  <div id="currentBit" style="font-weight: bold;"></div>
  <button onclick="restartGame()">üîÅ Restart Game</button>
  <div id="popup" class="popup"></div>

  <div class="board-container">
    <div class="board-box">
      <h3>Z-Board (Standard Basis)</h3>
      <svg id="zBoard" width="700" height="700"></svg>
    </div>
    <div class="board-box">
      <h3>X-Board (Hadamard Basis)</h3>
      <svg id="xBoard" width="700" height="700"></svg>
    </div>
  </div>

  <script>
    // ‚úÖ Firebase Initialization
    const firebaseConfig = {
      apiKey: "AIzaSyCdQqslJWy7VvqFkGufza8cY_G-xCE0Vuw",
      authDomain: "quantum-hex.firebaseapp.com",
      databaseURL: "https://quantum-hex-default-rtdb.firebaseio.com",
      projectId: "quantum-hex",
      storageBucket: "quantum-hex.appspot.com",
      messagingSenderId: "947590339914",
      appId: "1:947590339914:web:e033465cba45a73b0cb5b3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const SIZE = 11;
    const EMPTY = ".";
    const Z = "Z", X = "X";
    let boardZ, boardX, lockedZ, lockedX, turn, coinString, winner;
    let gameMode = 'local', roomId = '';

    function initializeGame() {
      boardZ = Array.from({ length: SIZE }, () => Array(SIZE).fill(EMPTY));
      boardX = Array.from({ length: SIZE }, () => Array(SIZE).fill(EMPTY));
      lockedZ = Array.from({ length: SIZE }, () => Array(SIZE).fill(false));
      lockedX = Array.from({ length: SIZE }, () => Array(SIZE).fill(false));
      turn = 0;
      winner = null;
      coinString = Array.from({ length: 300 }, () => Math.random() < 0.5 ? "0" : "1").join("");
      document.getElementById("coinString").textContent = coinString;
      drawAllBoards();
      updateStatus();
      updateCoinHint();
    }

    function restartGame() {
      if (gameMode === 'online') {
        saveGameState();  // reset on firebase
      } else {
        initializeGame();
      }
    }

    function setMode(mode) {
      gameMode = mode;
      if (mode === 'online') {
        document.getElementById("online-setup").style.display = 'block';
      } else {
        document.getElementById("online-setup").style.display = 'none';
        initializeGame();
      }
    }

    function joinOnline() {
      roomId = document.getElementById("roomId").value.trim();
      if (!roomId) return alert("Enter valid Room ID");
      const ref = db.ref("games/" + roomId);
      ref.once("value", snap => {
        if (snap.exists()) {
          const data = snap.val();
          boardZ = data.boardZ; boardX = data.boardX;
          lockedZ = data.lockedZ; lockedX = data.lockedX;
          coinString = data.coinString; turn = data.turn; winner = null;
        } else {
          initializeGame();
        }
        drawAllBoards(); updateStatus(); updateCoinHint();
        listenForUpdates(); saveGameState();
      });
    }

    function saveGameState() {
      if (gameMode === 'online' && roomId) {
        db.ref("games/" + roomId).set({ boardZ, boardX, lockedZ, lockedX, coinString, turn });
      }
    }

    function listenForUpdates() {
      db.ref("games/" + roomId).on("value", snap => {
        const data = snap.val(); if (!data) return;
        boardZ = data.boardZ; boardX = data.boardX;
        lockedZ = data.lockedZ; lockedX = data.lockedX;
        coinString = data.coinString; turn = data.turn;
        drawAllBoards(); updateStatus(); updateCoinHint();
      });
    }

    function drawAllBoards() {
      drawHexBoard("zBoard", boardZ, Z);
      drawHexBoard("xBoard", boardX, X);
    }

    function drawHexBoard(svgId, board, boardType) {
      const svg = document.getElementById(svgId); svg.innerHTML = "";
      const hexSize = 20, hexW = Math.sqrt(3) * hexSize, hexH = 1.5 * hexSize;
      for (let y = 0; y < SIZE; y++) {
        for (let x = 0; x < SIZE; x++) {
          const cx = 60 + x * hexW + y * hexW / 2;
          const cy = 60 + y * hexH;
          const p = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
          p.setAttribute("points", hexPoints(cx, cy, hexSize));
          p.setAttribute("stroke", outerStroke(x, y)); p.setAttribute("stroke-width", "1.5");
          p.setAttribute("fill",
            board[y][x] === "0" || board[y][x] === "+" ? "#f88" :
            board[y][x] === "1" || board[y][x] === "-" ? "#88f" : "#eee");
          p.style.cursor = "pointer";
          p.onclick = () => handleClick(boardType, x, y);
          svg.appendChild(p);
          const t = document.createElementNS("http://www.w3.org/2000/svg", "text");
          t.setAttribute("x", cx); t.setAttribute("y", cy + 5);
          t.setAttribute("text-anchor", "middle");
          t.setAttribute("font-size", "14");
          t.textContent = board[y][x] === EMPTY ? "" : board[y][x];
          svg.appendChild(t);
        }
      }
    }

    function outerStroke(x, y) {
      if (y === 0 || y === SIZE - 1) return "red";
      if (x === 0 || x === SIZE - 1) return "blue";
      return "#555";
    }

    function hexPoints(cx, cy, r) {
      return Array.from({ length: 6 }, (_, i) => {
        const angle = Math.PI / 3 * i;
        return `${cx + r * Math.cos(angle)},${cy + r * Math.sin(angle)}`;
      }).join(" ");
    }

    function handleClick(boardType, x, y) {
      if (turn >= coinString.length || winner) return;
      const current = turn % 2 === 0 ? "R" : "B";
      const c = coinString[turn];
      const fromBoard = boardType === Z ? boardZ : boardX;
      const toBoard = boardType === Z ? boardX : boardZ;
      const fromLock = boardType === Z ? lockedZ : lockedX;
      const toLock = boardType === Z ? lockedX : lockedZ;
      if (fromLock[y][x]) return;
      const symbol = boardType === Z ? (current === "R" ? "0" : "1") : (current === "R" ? "+" : "-");
      fromBoard[y][x] = symbol;
      fromLock[y][x] = true;
      if (!toLock[y][x]) {
        toBoard[y][x] = syncValue(symbol, c);
        toLock[y][x] = true;
      }
      turn++; checkWin(); drawAllBoards(); updateStatus(); updateCoinHint(); saveGameState();
    }

    function syncValue(val, bit) {
      const flip = bit === "1";
      return { "0": flip ? "-" : "+", "1": flip ? "+" : "-",
               "+": flip ? "1" : "0", "-": flip ? "0" : "1" }[val];
    }

    function updateStatus() {
      document.getElementById("status").textContent = "Turn " + turn + ": Player " + (turn % 2 === 0 ? "Red" : "Blue");
      document.getElementById("currentBit").textContent = "Current coin bit (c_" + turn + ") = " + coinString[turn];
    }

    function updateCoinHint() {
      const bits = coinString.slice(0, 20).split("");
      const players = bits.map((_, i) => i % 2 === 0 ? "R" : "B");
      const stones = bits.map((bit, i) => bit === "0" ? players[i] : players[i] === "R" ? "B" : "R");
      document.getElementById("coinHint").textContent =
        "Public coin : " + bits.join(" ") + "\n" +
        "Stone_Uplay : " + players.join(" ") + "\n" +
        "Stone_other : " + stones.join(" ");
    }

    function checkWin() {
      const zRed = hasPath("0", boardZ, true);
      const zBlue = hasPath("1", boardZ, false);
      const xRed = hasPath("+", boardX, true);
      const xBlue = hasPath("-", boardX, false);
      if (zRed || xRed) showPopup("Player R wins!");
      if (zBlue || xBlue) showPopup("Player B wins!");
    }

    function hasPath(symbol, board, vertical) {
      const visited = new Set(), stack = [];
      for (let i = 0; i < SIZE; i++) {
        if (vertical && board[0][i] === symbol) stack.push([0, i]);
        if (!vertical && board[i][0] === symbol) stack.push([i, 0]);
      }
      while (stack.length) {
        const [x, y] = stack.pop(), key = `${x},${y}`;
        if (visited.has(key)) continue; visited.add(key);
        if ((vertical && x === SIZE - 1) || (!vertical && y === SIZE - 1)) return true;
        for (const [dx, dy] of [[1,0],[-1,0],[0,1],[0,-1],[1,-1],[-1,1]]) {
          const nx = x + dx, ny = y + dy;
          if (nx >= 0 && ny >= 0 && nx < SIZE && ny < SIZE && board[nx][ny] === symbol)
            stack.push([nx, ny]);
        }
      }
      return false;
    }

    function showPopup(msg) {
      winner = msg.includes("R") ? "Red" : "Blue";
      const p = document.getElementById("popup");
      p.textContent = msg; p.style.display = "block";
      setTimeout(() => { p.style.display = "none"; }, 2000);
    }

    initializeGame();
  </script>
</body>
</html>
